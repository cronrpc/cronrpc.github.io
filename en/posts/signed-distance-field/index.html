<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Signed Distance Field | cronrpc</title>
<meta name=keywords content="Image Processing,sdf"><meta name=description content="Introduction to SDF
Signed Distance Field (SDF)
Signed Distance Field (SDF)1 is a mathematical function or data structure used to represent shapes.
In 2D or 3D space, it assigns each point a signed distance value, which represents the distance to the nearest surface (or boundary), with the sign distinguishing between inside and outside:

Positive value: The point is outside the shape, and the value indicates the nearest distance to the surface.
Negative value: The point is inside the shape, and the absolute value indicates the nearest distance to the surface.
Zero: The point lies exactly on the surface of the shape.

Formally, for a point $x$ in space, an SDF can be defined as:"><meta name=author content="cronrpc"><link rel=canonical href=https://cronrpc.github.io/en/posts/signed-distance-field/><link crossorigin=anonymous href=/assets/css/stylesheet.2211ca3164be7830024f6aad2b3a2e520843a64f8f048445c3401c1249aa051d.css integrity="sha256-IhHKMWS+eDACT2qtKzouUghDpk+PBIRFw0AcEkmqBR0=" rel="preload stylesheet" as=style><link rel=icon href=https://cronrpc.github.io/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://cronrpc.github.io/icons/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://cronrpc.github.io/icons/favicon-32x32.png><link rel=apple-touch-icon href=https://cronrpc.github.io/icons/apple-touch-icon.png><link rel=mask-icon href=https://cronrpc.github.io/icons/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://cronrpc.github.io/en/posts/signed-distance-field/><link rel=alternate hreflang=zh href=https://cronrpc.github.io/zh/posts/signed-distance-field/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><meta property="og:url" content="https://cronrpc.github.io/en/posts/signed-distance-field/"><meta property="og:site_name" content="cronrpc"><meta property="og:title" content="Signed Distance Field"><meta property="og:description" content="Introduction to SDF Signed Distance Field (SDF) Signed Distance Field (SDF)1 is a mathematical function or data structure used to represent shapes. In 2D or 3D space, it assigns each point a signed distance value, which represents the distance to the nearest surface (or boundary), with the sign distinguishing between inside and outside:
Positive value: The point is outside the shape, and the value indicates the nearest distance to the surface. Negative value: The point is inside the shape, and the absolute value indicates the nearest distance to the surface. Zero: The point lies exactly on the surface of the shape. Formally, for a point $x$ in space, an SDF can be defined as:"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-08-13T20:25:38+08:00"><meta property="article:modified_time" content="2025-08-13T20:25:38+08:00"><meta property="article:tag" content="Image Processing"><meta property="article:tag" content="Sdf"><meta property="og:image" content="https://cronrpc.github.io/cover.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://cronrpc.github.io/cover.jpg"><meta name=twitter:title content="Signed Distance Field"><meta name=twitter:description content="Introduction to SDF
Signed Distance Field (SDF)
Signed Distance Field (SDF)1 is a mathematical function or data structure used to represent shapes.
In 2D or 3D space, it assigns each point a signed distance value, which represents the distance to the nearest surface (or boundary), with the sign distinguishing between inside and outside:

Positive value: The point is outside the shape, and the value indicates the nearest distance to the surface.
Negative value: The point is inside the shape, and the absolute value indicates the nearest distance to the surface.
Zero: The point lies exactly on the surface of the shape.

Formally, for a point $x$ in space, an SDF can be defined as:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://cronrpc.github.io/en/posts/"},{"@type":"ListItem","position":2,"name":"Signed Distance Field","item":"https://cronrpc.github.io/en/posts/signed-distance-field/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Signed Distance Field","name":"Signed Distance Field","description":"Introduction to SDF Signed Distance Field (SDF) Signed Distance Field (SDF)1 is a mathematical function or data structure used to represent shapes. In 2D or 3D space, it assigns each point a signed distance value, which represents the distance to the nearest surface (or boundary), with the sign distinguishing between inside and outside:\nPositive value: The point is outside the shape, and the value indicates the nearest distance to the surface. Negative value: The point is inside the shape, and the absolute value indicates the nearest distance to the surface. Zero: The point lies exactly on the surface of the shape. Formally, for a point $x$ in space, an SDF can be defined as:\n","keywords":["Image Processing","sdf"],"articleBody":"Introduction to SDF Signed Distance Field (SDF) Signed Distance Field (SDF)1 is a mathematical function or data structure used to represent shapes. In 2D or 3D space, it assigns each point a signed distance value, which represents the distance to the nearest surface (or boundary), with the sign distinguishing between inside and outside:\nPositive value: The point is outside the shape, and the value indicates the nearest distance to the surface. Negative value: The point is inside the shape, and the absolute value indicates the nearest distance to the surface. Zero: The point lies exactly on the surface of the shape. Formally, for a point $x$ in space, an SDF can be defined as:\n$$ f(x) = \\begin{cases} d(x, \\partial\\Omega), \u0026 \\text{if } x \\in \\Omega \\\\ -d(x, \\partial\\Omega), \u0026 \\text{if } x \\notin \\Omega \\\\ 0, \u0026 \\text{if } x \\in \\partial\\Omega \\end{cases} $$\nwhere $\\Omega$ denotes the interior of the object, $\\partial\\Omega$ its boundary, and $d(x, \\partial\\Omega)$ the minimum distance from $x$ to the boundary.\nGitHub Repository If you want to check out the final code that generates SDF images, you can find it in the GitHub repo2: cronrpc/Signed-Distance-Field-2D-Generator\nApplications The definition above may sound abstract, so let’s look at some practical applications:\nFont rendering (Valve’s SDF font technology3; Unity’s TMP fonts use SDF as well). Surface intersection in ray tracing\nStylized shadows, clouds, and similar effects\nIn general, any scenario involving continuous transitions can potentially leverage SDF techniques.\n2D SDF Generation Algorithms For a grayscale image where white represents the object and black represents the background, how do we generate an SDF image?\nBrute-Force Evaluation The simplest approach is brute force:\nIdentify all boundary pixels (a white pixel with at least one black neighbor). For every pixel, compute the nearest distance to the boundary set. Assign a positive or negative sign based on whether the pixel itself is inside (white) or outside (black). If the total number of pixels is $n$, the complexity is $O(n^2)$.\n# generator_sdf.py import sys import math from PIL import Image import numpy as np def generate_sdf(input_path, output_path): # Read grayscale image (0–255) img = Image.open(input_path).convert(\"L\") w, h = img.size pixels = np.array(img) # Step 1: Find boundary pixels boundary_points = [] for y in range(h): for x in range(w): if pixels[y, x] \u003e 127: neighbors = [ (nx, ny) for nx in (x - 1, x, x + 1) for ny in (y - 1, y, y + 1) if 0 \u003c= nx \u003c w and 0 \u003c= ny \u003c h and not (nx == x and ny == y) ] for nx, ny in neighbors: if pixels[ny, nx] \u003c= 127: boundary_points.append((x, y)) break # Step 2 \u0026 3: Compute SDF sdf = np.zeros((h, w), dtype=np.float32) for y in range(h): for x in range(w): min_dist = float(\"inf\") for bx, by in boundary_points: dist = math.sqrt((x - bx) ** 2 + (y - by) ** 2) if dist \u003c min_dist: min_dist = dist # Negative for background if pixels[y, x] \u003c= 127: min_dist = -min_dist sdf[y, x] = min_dist # Normalize to 0–255 max_dist = np.max(np.abs(sdf)) sdf_normalized = ((sdf / max_dist) + 1) * 127.5 sdf_img = Image.fromarray(np.clip(sdf_normalized, 0, 255).astype(np.uint8)) sdf_img.save(output_path) print(f\"SDF saved to {output_path}\") if __name__ == \"__main__\": if len(sys.argv) != 3: print(\"Example: python generator_sdf.py test.png test_sdf.png\") sys.exit(1) generate_sdf(sys.argv[1], sys.argv[2]) Generated result:\nBy adjusting the display threshold in Photoshop, we can observe the SDF transitions:\nSimilarly, for a square, its SDF exhibits right-angle contours inside and circular contours outside:\n8-Neighborhood Euclidean Approximation A metric space 4 is an abstract mathematical framework that defines the notion of “distance.” It consists of a set $X$ and a distance function\n$$ d : X \\times X \\to \\mathbb{R} $$\nwhich must satisfy the following four conditions:\nNon-negativity: Distance is always non-negative. Identity: Distance is zero if and only if the two points are identical. Symmetry: The distance from $x$ to $y$ is the same as from $y$ to $x$. Triangle inequality: Taking a detour should never be shorter than going directly. $$ d(x, z) \\le d(x, y) + d(y, z) $$\nFor example, in the continuous 2D plane, the Euclidean distance\n$$ d(P, Q) = \\sqrt{(x_P - x_Q)^2 + (y_P - y_Q)^2} $$\nis a typical metric.\nIn the figure below, the blue, red, and yellow lines all represent the same length, while the green line is the shorter Euclidean distance.\nHowever, in digital image processing or raster maps, our points are discrete pixels. While distances can be computed using the Euclidean formula, doing so requires many square root operations, which are computationally expensive.\nTo improve efficiency, we often use the 8-neighborhood Euclidean approximation:\n8-neighborhood: Each pixel is considered adjacent to the 8 nearest pixels — horizontally, vertically, and diagonally. The approximate Euclidean distance is then defined as: $$ d_{8}(p, q) \\approx \\max(\\Delta x, \\Delta y) + (\\sqrt{2} - 1) \\cdot \\min(\\Delta x, \\Delta y) $$\nwhere $\\Delta x = |x_p - x_q|$，$\\Delta y = |y_p - y_q|$。\nFor example, in the figure below, the red path represents the 8-neighborhood Euclidean approximation, while the blue line is the true Euclidean distance.\nThis method avoids costly square root operations, and within the 8-neighborhood its error compared to the true Euclidean distance is small. Therefore, it is widely used in pathfinding (A*, Dijkstra), distance transforms, and morphological image processing.\n8SSEDT This algorithm is based on Lisapple’s 8SSEDT5.\nIn the previous section, we introduced the 8-neighborhood Euclidean approximation. In fact, for each node in the grid, its distance can be expressed recursively as:\n$$ f(x, y) = \\min_{\\substack{dx, dy \\in {-1,0,1} \\ (dx, dy) \\neq (0,0)}} \\Big( f(x+dx, y+dy) + d(dx, dy) \\Big) $$\nwhere $d(dx, dy)$ is the cost of moving from neighbor $(x+dx, y+dy)$ to $(x, y)$, usually defined as:\n$$ d(dx, dy) = \\begin{cases} 1, \u0026 \\text{where } |dx| + |dy| = 1 \\quad (\\text{horizontal or vertical neighbor})\\\\ \\sqrt{2}, \u0026 \\text{where } |dx| + |dy| = 2 \\quad (\\text{diagonal neighbor}) \\end{cases} $$\nHere, $dx$ and $dy$ can each be $-1, 0, 1$, but not both zero, since that would not be a neighbor.\nIf we label the neighbors:\n[#1][#2][#3] [#4][ x][#5] [#6][#7][#8] The path between any two points $x$ and $y$ must be composed of one of the following four combinations:\n1,2,4 2,3,5 4,6,7 5,7,8 Thus, propagating from the top-left to the bottom-right covers the $1,2,4$ case, meaning that at most four full passes over the grid are needed to compute all values.\nAn optimization, inspired by Signed Distance Fields6, chooses the following four traversal paths instead:\n- - - \u003e | [?][?][?] | [?][x][ ] v [ ][ ][ ] \u003c - - - | [ ][ ][ ] | [ ][x][?] v [ ][ ][ ] \u003c - - - ^ [ ][ ][ ] | [ ][x][?] | [?][?][?] - - - \u003e ^ [ ][ ][ ] | [?][x][ ] | [ ][ ][ ] Here is the Python implementation:\nStrictly speaking, the following code computes the true Euclidean distance, not the 8-neighborhood approximation. It only borrows the idea of 8 possible directions of movement. import sys import os import numpy as np from PIL import Image INF = 9999 def dist_sq(dx, dy): return dx*dx + dy*dy def compare(grid, p, x, y, ox, oy, width, height): nx = x + ox ny = y + oy if 0 \u003c= nx \u003c width and 0 \u003c= ny \u003c height: other_dx, other_dy = grid[ny, nx] else: other_dx, other_dy = INF, INF other_dx += ox other_dy += oy if dist_sq(other_dx, other_dy) \u003c dist_sq(*p): p = (other_dx, other_dy) return p def generate_sdf(grid): height, width, _ = grid.shape # Pass 0 for y in range(height): for x in range(width): p = tuple(grid[y, x]) p = compare(grid, p, x, y, -1, 0, width, height) p = compare(grid, p, x, y, 0, -1, width, height) p = compare(grid, p, x, y, -1, -1, width, height) p = compare(grid, p, x, y, 1, -1, width, height) grid[y, x] = p for x in range(width-1, -1, -1): p = tuple(grid[y, x]) p = compare(grid, p, x, y, 1, 0, width, height) grid[y, x] = p # Pass 1 for y in range(height-1, -1, -1): for x in range(width-1, -1, -1): p = tuple(grid[y, x]) p = compare(grid, p, x, y, 1, 0, width, height) p = compare(grid, p, x, y, 0, 1, width, height) p = compare(grid, p, x, y, -1, 1, width, height) p = compare(grid, p, x, y, 1, 1, width, height) grid[y, x] = p for x in range(width): p = tuple(grid[y, x]) p = compare(grid, p, x, y, -1, 0, width, height) grid[y, x] = p def load_image_binary(path, threshold=128): im = Image.open(path).convert('L') arr = np.array(im, dtype=np.uint8) inside = arr \u003c threshold return inside, im def save_signed_sdf_image(signed, out_path): max_dist = np.max(np.abs(signed)) if max_dist == 0: sdf_normalized = np.full_like(signed, 128.0) else: sdf_normalized = ((signed / max_dist) + 1.0) * 128.0 sdf_normalized = np.clip(sdf_normalized, 0, 255).astype(np.uint8) out = Image.fromarray(sdf_normalized, mode='L') out.save(out_path) def main(): if len(sys.argv) \u003c 2: print(\"Usage: python 8ssedt.py input.png\") sys.exit(1) in_path = sys.argv[1] if not os.path.exists(in_path): print(\"File not found:\", in_path) sys.exit(1) inside, im = load_image_binary(in_path) h, w = inside.shape empty = (INF, INF) zero = (0, 0) # two grids: inside distances and outside distances grid1 = np.zeros((h, w, 2), dtype=int) grid2 = np.zeros((h, w, 2), dtype=int) for y in range(h): for x in range(w): if inside[y, x]: grid1[y, x] = zero grid2[y, x] = empty else: grid1[y, x] = empty grid2[y, x] = zero generate_sdf(grid1) generate_sdf(grid2) dist1 = np.sqrt(grid1[:, :, 0]**2 + grid1[:, :, 1]**2) dist2 = np.sqrt(grid2[:, :, 0]**2 + grid2[:, :, 1]**2) signed = dist1 - dist2 base, ext = os.path.splitext(in_path) out_path = base + \"_8ssedt.png\" save_signed_sdf_image(signed, out_path) print(\"Saved:\", out_path) if __name__ == \"__main__\": main() We can test it on this input image:\nAfter running the script, we get:\nVisualized in Photoshop with different thresholds:\nCorrect 8SSEDT As noted in 7, the issue with binary black-and-white images is that for pixels near the boundary, the true distance to the boundary should actually be only half a pixel.\nIgnoring this half-pixel offset leads to small inaccuracies near boundaries. The fix is to add only half the step size when the neighboring pixel is on the boundary.\nimport sys import os import math import numpy as np from PIL import Image FIX = True INF = 9999 def dist_sq(dx, dy): return dx*dx + dy*dy def compare(grid, p, x, y, ox, oy, width, height): nx = x + ox ny = y + oy if 0 \u003c= nx \u003c width and 0 \u003c= ny \u003c height: other_dx, other_dy = grid[ny, nx] else: other_dx, other_dy = INF, INF if FIX: if other_dx != 0 or other_dy != 0: ox *= 2 oy *= 2 other_dx += ox other_dy += oy if dist_sq(other_dx, other_dy) \u003c dist_sq(*p): p = (other_dx, other_dy) return p def generate_sdf(grid): height, width, _ = grid.shape # Pass 0 for y in range(height): for x in range(width): p = tuple(grid[y, x]) p = compare(grid, p, x, y, -1, 0, width, height) p = compare(grid, p, x, y, 0, -1, width, height) p = compare(grid, p, x, y, -1, -1, width, height) p = compare(grid, p, x, y, 1, -1, width, height) grid[y, x] = p for x in range(width-1, -1, -1): p = tuple(grid[y, x]) p = compare(grid, p, x, y, 1, 0, width, height) grid[y, x] = p # Pass 1 for y in range(height-1, -1, -1): for x in range(width-1, -1, -1): p = tuple(grid[y, x]) p = compare(grid, p, x, y, 1, 0, width, height) p = compare(grid, p, x, y, 0, 1, width, height) p = compare(grid, p, x, y, -1, 1, width, height) p = compare(grid, p, x, y, 1, 1, width, height) grid[y, x] = p for x in range(width): p = tuple(grid[y, x]) p = compare(grid, p, x, y, -1, 0, width, height) grid[y, x] = p def load_image_binary(path, threshold=128): im = Image.open(path).convert('L') arr = np.array(im, dtype=np.uint8) inside = arr \u003c threshold return inside, im def save_signed_sdf_image(signed, out_path): max_dist = np.max(np.abs(signed)) if max_dist == 0: sdf_normalized = np.full_like(signed, 128.0) else: sdf_normalized = ((signed / max_dist) + 1.0) * 128.0 sdf_normalized = np.clip(sdf_normalized, 0, 255).astype(np.uint8) out = Image.fromarray(sdf_normalized, mode='L') out.save(out_path) def main(): if len(sys.argv) \u003c 2: print(\"Usage: python 8ssedt.py input.png\") sys.exit(1) in_path = sys.argv[1] if not os.path.exists(in_path): print(\"File not found:\", in_path) sys.exit(1) inside, im = load_image_binary(in_path) h, w = inside.shape empty = (INF, INF) zero = (0, 0) # two grids: inside distances and outside distances grid1 = np.zeros((h, w, 2), dtype=int) grid2 = np.zeros((h, w, 2), dtype=int) for y in range(h): for x in range(w): if inside[y, x]: grid1[y, x] = zero grid2[y, x] = empty else: grid1[y, x] = empty grid2[y, x] = zero generate_sdf(grid1) generate_sdf(grid2) dist1 = np.sqrt(grid1[:, :, 0]**2 + grid1[:, :, 1]**2) dist2 = np.sqrt(grid2[:, :, 0]**2 + grid2[:, :, 1]**2) if FIX: signed = 0.5 * (dist1 - dist2) else: signed = dist1 - dist2 base, ext = os.path.splitext(in_path) out_path = base + \"_8ssedt_correct.png\" save_signed_sdf_image(signed, out_path) print(\"Saved:\", out_path) if __name__ == \"__main__\": main() The results look nearly identical to the original:\nBut when visualized at different thresholds, the corrected version is slightly smoother near boundaries:\nCorrected:\nOriginal:\nWhy Still Use Euclidean Distance? Consider the approximation formula:\n$$ d_8(p,q) = \\max(\\Delta x,\\Delta y) + (\\sqrt{2} - 1) \\cdot \\min(\\Delta x,\\Delta y) $$\nTake two points: $(1,4)$ and $(3,3)$.\n计算 $d_8$\n$d_8(1,4) = 4 + (\\sqrt{2} - 1) \\cdot 1 \\approx 4 + 0.4142 = 4.4142$\n$d_8(3,3) = 3 + (\\sqrt{2} - 1) \\cdot 3 \\approx 3 + 1.2426 = 4.2426$\n⇒ $d_8(1,4) \u003e d_8(3,3)$\n计算欧几里得距离\n$d_E(1,4) = \\sqrt{1^2 + 4^2} = \\sqrt{17} \\approx 4.1231$\n$d_E(3,3) = \\sqrt{3^2 + 3^2} = \\sqrt{18} \\approx 4.2426$\n⇒ $d_E(1,4) \u003c d_E(3,3)$\nThis counterexample shows that $d_8$ does not always preserve the same ordering as Euclidean distance. Therefore, we only borrow the 8-neighborhood displacements, but still compute distances using the Euclidean metric.\nThe scipy.ndimage Library The previous Python implementation is slow due to nested loops, especially at resolutions like 2048×2048.\nscipy.ndimage provides a much faster alternative, as its image processing functions are implemented in C++.\nIn the following code, we use a fixed scale of 8 (explained later), and output 16-bit grayscale images instead of 8-bit.\nimport sys import os import numpy as np from PIL import Image from scipy import ndimage scale = 8 def load_image_binary(path, threshold=128): im = Image.open(path).convert('L') arr = np.array(im, dtype=np.uint8) inside = arr \u003c threshold return inside def save_sdf_16bit(signed, out_path): signed = signed * scale + 32767.5 signed_uint16 = np.clip(signed, 0, 65535).astype(np.uint16) out = Image.fromarray(signed_uint16, mode='I;16') out.save(out_path) def fast_signed_sdf(mask): dist_inside = ndimage.distance_transform_edt(mask) dist_outside = ndimage.distance_transform_edt(~mask) return dist_outside - dist_inside def main(): if len(sys.argv) \u003c 2: print(\"Usage: python fast_sdf.py input1.png [input2.png ...]\") sys.exit(1) for in_path in sys.argv[1:]: if not os.path.exists(in_path): print(\"File not found:\", in_path) continue inside = load_image_binary(in_path) signed = fast_signed_sdf(inside) base, _ = os.path.splitext(in_path) out_path = base + \"_sdf16.png\" save_sdf_16bit(signed, out_path) print(f\"Saved SDF to {out_path}\") if __name__ == \"__main__\": main() 16bit 和 scale Earlier, we normalized distances, but if we want to combine multiple images, the distance units must be consistent (since interpolation between SDFs depends on this).\nFurthermore, with large images (e.g., 2048×2048), 8-bit depth (0–255) is insufficient to represent the full range of distances. To avoid truncation artifacts, we use 16-bit PNGs.\nFor a 2048×2048 image, the maximum possible distance is about $2048 \\cdot 1.414 \\approx 2896$. Since 16-bit integers can represent up to $\\pm32767$, we can safely choose a scale factor of 8 or 10.\nscale = 10 # Map to 0–65535, 32767.5 as the boundary unsigned = signed * scale + 32767.5 unsigned = np.clip(unsigned, 0, 65535).astype(np.uint16) Composition Algorithms How to combine SDFs depends on the desired effect.\nFor example, if we want a subtraction, can we simply subtract the distance fields?\nThis works at the midpoint, but at the edges the meaning becomes unclear:\n# Boolean operations def sdf_union(d1, d2): return np.minimum(d1, d2) # Union def sdf_intersection(d1, d2): return np.maximum(d1, d2) # Intersection def sdf_subtraction(d1, d2): return np.maximum(d1, -d2) # A subtract B These operations essentially define the effect when crossing the threshold boundary.\nInterpolation Approach In games, what we often want is this: given two images a and b, at maximum threshold we see a, at minimum threshold we see b.\nFor three images, the highest threshold shows a, the middle threshold shows b, and the lowest threshold shows c, and so on.\nA key requirement is that they must have a containment relationship: $c \\supset b \\supset a$. Otherwise, the transition cannot be well-defined.\nFor an arbitrary pixel in a, its distance values in both a and b should be positive (inside).\nFor a pixel in $b - a$, its distance in a will be negative ($x_a$), and in b positive ($x_b$). Thus, the final SDF value $x_{final}$ is determined by finding the threshold where interpolation between $x_a$ and $x_b$ crosses zero.\nFor example, if ${sdf}_a = -3$ and ${sdf}b = 3$, then at 8-bit gray, ${x}{final}$ should be 128 — meaning the pixel is lit at thresholds below 128.\nSo the core idea is: find the zero-crossing point.\nMonte Carlo Interpolation We can approximate the zero point via sampling, as in 8.\nNote that pure Python with nested loops is too slow for large images (\u003e2048).\nimport sys import numpy as np from PIL import Image if len(sys.argv) != 3: print(\"Usage: python compose2.py a.png b.png\") sys.exit(1) # Load a 16-bit grayscale image def load_16bit_gray(path): img = Image.open(path) arr = np.array(img, dtype=np.uint16) return arr sdf1 = load_16bit_gray(sys.argv[1]) sdf2 = load_16bit_gray(sys.argv[2]) # Ensure dimensions match if sdf1.shape != sdf2.shape: raise ValueError(\"The two input images must have the same dimensions\") height, width = sdf1.shape output = np.zeros((height, width), dtype=np.uint16) THRESHOLD = 32768 # 16-bit midpoint (0.5 grayscale) MAX_VAL = 65535 STEPS = 16 for y in range(height): for x in range(width): t1 = sdf1[y, x] t2 = sdf2[y, x] if t1 \u003c THRESHOLD and t2 \u003c THRESHOLD: result = 0 elif t1 \u003e THRESHOLD and t2 \u003e THRESHOLD: result = MAX_VAL else: # Interpolate between the two images result = 0 for i in range(STEPS): weight = i / STEPS interp = (1 - weight) * t1 + weight * t2 result += 0 if interp \u003c THRESHOLD else MAX_VAL result //= STEPS output[y, x] = np.clip(result, 0, MAX_VAL) # Save as 16-bit PNG out_img = Image.fromarray(output, mode='I;16') out_img.save(\"output.png\") print(\"Composition complete: output.png\") Final Algorithm This interpolation is highly parallel: each pixel is independent, and interpolating across images is also independent.\nUsing NumPy for vectorized operations achieves high performance (NumPy is backed by optimized C++).\nHere we sample 256 points across the grayscale range, and output an 8-bit grayscale image (16-bit is unnecessary for the final composite).\nimport sys import numpy as np from PIL import Image U8 = True if len(sys.argv) \u003c 3: print(\"Example: python compose.py img1.png img2.png [img3.png ...]\") sys.exit(1) def load_16bit_gray(path): img = Image.open(path) arr = np.array(img, dtype=np.uint16) return arr images = [load_16bit_gray(path) for path in sys.argv[1:]] arr = np.stack(images, axis=0) # shape: (N, H, W) if not np.all([img.shape == arr[0].shape for img in images]): raise ValueError(\"All input images must have the same dimensions\") THRESHOLD = 32768 MAX_VAL = 65535 N, H, W = arr.shape # Global masks all_below = np.all(arr \u003c THRESHOLD, axis=0) all_above = np.all(arr \u003e THRESHOLD, axis=0) output = np.zeros((H, W), dtype=np.float64) output[all_below] = 0 output[all_above] = MAX_VAL # Mixed region mask mix_mask = ~(all_below | all_above) # Extract pixels in the mixed region mix_pixels = arr[:, mix_mask].astype(np.float64) # shape: (N, M) M = number of mixed pixels M = mix_pixels.shape[1] # 256 sampling weights samples = 256 weights = np.linspace(0, 1, samples, endpoint=False) # Which two images each sample point belongs to intervals = np.floor(weights * (N - 1)).astype(int) # shape: (samples,) local_w = (weights * (N - 1)) - intervals # shape: (samples,) # Batch interpolation interp_results = np.zeros((samples, M), dtype=np.float64) for k in range(samples): i1 = intervals[k] i2 = i1 + 1 val = (1 - local_w[k]) * mix_pixels[i1] + local_w[k] * mix_pixels[i2] interp_results[k] = (val \u003e= THRESHOLD) * MAX_VAL # Average results res = np.mean(interp_results, axis=0) # Write results back output[mix_mask] = res if U8: # Convert to float, map to 0–255 output_float = output.astype(np.float32) output_scaled = output_float / 65535.0 * 255.0 output_uint8 = np.clip(np.floor(output_scaled + 0.5), 0, 255).astype(np.uint8) # Save 8-bit grayscale out_img = Image.fromarray(output_uint8, mode='L') out_img.save(\"output8.png\") print(f\"Composition complete: output8.png, merged {N} images\") else: output = np.clip(output, 0, MAX_VAL).astype(np.uint16) out_img = Image.fromarray(output, mode='I;16') out_img.save(\"output16.png\") print(f\"Composition complete: output16.png, merged {N} images\") Result:\nOriginal images:\nGenerated SDFs (scaled, so they appear grayish):\nComposited SDF:\nwikipedia, Signed distance function, https://en.wikipedia.org/wiki/Signed_distance_function ↩︎\ncronrpc, (2025), Signed Distance Field 2D Generator, https://github.com/cronrpc/Signed-Distance-Field-2D-Generator ↩︎\nChris Green. Valve. (2007). Improved Alpha-Tested Magnification for Vector Textures and Special Effects, https://steamcdn-a.akamaihd.net/apps/valve/2007/SIGGRAPH2007_AlphaTestedMagnification.pdf ↩︎\nMetric Space, https://en.wikipedia.org/wiki/Metric_space ↩︎\nLisapple, (2017), 8SSEDT , GitHub, https://github.com/Lisapple/8SSEDT ↩︎\nRichard Mitton, (2009), Signed Distance Fields, http://www.codersnotes.com/notes/signed-distance-fields/ ↩︎\nfarteryhr, Correct 8SSEDT, https://replit.com/@farteryhr/Correct8SSEDT#main.cpp ↩︎\n蛋白胨, Unity 卡通渲染 程序化天空盒, https://zhuanlan.zhihu.com/p/540692272 ↩︎\n","wordCount":"3581","inLanguage":"en","image":"https://cronrpc.github.io/cover.jpg","datePublished":"2025-08-13T20:25:38+08:00","dateModified":"2025-08-13T20:25:38+08:00","author":{"@type":"Person","name":"cronrpc"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://cronrpc.github.io/en/posts/signed-distance-field/"},"publisher":{"@type":"Organization","name":"cronrpc","logo":{"@type":"ImageObject","url":"https://cronrpc.github.io/icons/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://cronrpc.github.io/en/ accesskey=h title="cronrpc (Alt + H)"><img src=https://cronrpc.github.io/apple-touch-icon.png alt aria-label=logo height=35>cronrpc</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://cronrpc.github.io/zh/ title=Chinese aria-label=Chinese>Zh</a></li></ul></div></div><ul id=menu><li><a href=https://cronrpc.github.io/en/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://cronrpc.github.io/en/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://cronrpc.github.io/en/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://cronrpc.github.io/en/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://cronrpc.github.io/en/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://cronrpc.github.io/en/>Home</a>&nbsp;»&nbsp;<a href=https://cronrpc.github.io/en/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Signed Distance Field</h1><div class=post-meta><span title='2025-08-13 20:25:38 +0800 +0800'>August 13, 2025</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;3581 words&nbsp;·&nbsp;cronrpc&nbsp;|&nbsp;Translations:<ul class=i18n_list><li><a href=https://cronrpc.github.io/zh/posts/signed-distance-field/>Zh</a></li></ul></div></header><figure class=entry-cover><img loading=eager srcset='https://cronrpc.github.io/zh/posts/signed-distance-field/cover_hu_e18ddece525aec73.jpg 360w,https://cronrpc.github.io/zh/posts/signed-distance-field/cover_hu_f29c23bc90ed4f43.jpg 480w,https://cronrpc.github.io/zh/posts/signed-distance-field/cover_hu_4670f4decd13ce14.jpg 720w,https://cronrpc.github.io/zh/posts/signed-distance-field/cover_hu_19e48f4d4d6e5371.jpg 1080w,https://cronrpc.github.io/zh/posts/signed-distance-field/cover_hu_dd289d064a6c7ac9.jpg 1500w,https://cronrpc.github.io/zh/posts/signed-distance-field/cover.jpg 1600w' src=https://cronrpc.github.io/zh/posts/signed-distance-field/cover.jpg sizes="(min-width: 768px) 720px, 100vw" width=1600 height=900 alt></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#introduction-to-sdf>Introduction to SDF</a><ul><li><a href=#signed-distance-field-sdf>Signed Distance Field (SDF)</a></li><li><a href=#github-repository>GitHub Repository</a></li><li><a href=#applications>Applications</a></li></ul></li><li><a href=#2d-sdf-generation-algorithms>2D SDF Generation Algorithms</a><ul><li><a href=#brute-force-evaluation>Brute-Force Evaluation</a></li><li><a href=#8-neighborhood-euclidean-approximation>8-Neighborhood Euclidean Approximation</a></li><li><a href=#8ssedt>8SSEDT</a></li><li><a href=#correct-8ssedt>Correct 8SSEDT</a></li><li><a href=#why-still-use-euclidean-distance>Why Still Use Euclidean Distance?</a></li><li><a href=#the-scipyndimage-library>The scipy.ndimage Library</a></li><li><a href=#16bit-和-scale>16bit 和 scale</a></li></ul></li><li><a href=#composition-algorithms>Composition Algorithms</a><ul><li><a href=#interpolation-approach>Interpolation Approach</a></li><li><a href=#monte-carlo-interpolation>Monte Carlo Interpolation</a></li><li><a href=#final-algorithm>Final Algorithm</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=introduction-to-sdf>Introduction to SDF<a hidden class=anchor aria-hidden=true href=#introduction-to-sdf>#</a></h2><h3 id=signed-distance-field-sdf>Signed Distance Field (SDF)<a hidden class=anchor aria-hidden=true href=#signed-distance-field-sdf>#</a></h3><p>Signed Distance Field (SDF)<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> is a mathematical function or data structure used to represent shapes.
In 2D or 3D space, it assigns each point a signed distance value, which represents the distance to the nearest surface (or boundary), with the sign distinguishing between inside and outside:</p><ul><li>Positive value: The point is outside the shape, and the value indicates the nearest distance to the surface.</li><li>Negative value: The point is inside the shape, and the absolute value indicates the nearest distance to the surface.</li><li>Zero: The point lies exactly on the surface of the shape.</li></ul><p>Formally, for a point $x$ in space, an SDF can be defined as:</p><p>$$
f(x) =
\begin{cases}
d(x, \partial\Omega), & \text{if } x \in \Omega \\
-d(x, \partial\Omega), & \text{if } x \notin \Omega \\
0, & \text{if } x \in \partial\Omega
\end{cases}
$$</p><p>where $\Omega$ denotes the interior of the object, $\partial\Omega$ its boundary, and $d(x, \partial\Omega)$ the minimum distance from $x$ to the boundary.</p><h3 id=github-repository>GitHub Repository<a hidden class=anchor aria-hidden=true href=#github-repository>#</a></h3><p>If you want to check out the final code that generates SDF images, you can find it in the GitHub repo<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>: <a href=https://github.com/cronrpc/Signed-Distance-Field-2D-Generator>cronrpc/Signed-Distance-Field-2D-Generator</a></p><h3 id=applications>Applications<a hidden class=anchor aria-hidden=true href=#applications>#</a></h3><p>The definition above may sound abstract, so let’s look at some practical applications:</p><ul><li>Font rendering (Valve’s SDF font technology<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>; Unity’s TMP fonts use SDF as well).</li></ul><p><img alt=valve-sdf-text-example loading=lazy src=/en/posts/signed-distance-field/valve-sdf-text-example.png></p><ul><li><p>Surface intersection in ray tracing</p></li><li><p>Stylized shadows, clouds, and similar effects</p></li></ul><p>In general, any scenario involving continuous transitions can potentially leverage SDF techniques.</p><h2 id=2d-sdf-generation-algorithms>2D SDF Generation Algorithms<a hidden class=anchor aria-hidden=true href=#2d-sdf-generation-algorithms>#</a></h2><p>For a grayscale image where white represents the object and black represents the background, how do we generate an SDF image?</p><p><img alt=circle loading=lazy src=/en/posts/signed-distance-field/circle.png></p><h3 id=brute-force-evaluation>Brute-Force Evaluation<a hidden class=anchor aria-hidden=true href=#brute-force-evaluation>#</a></h3><p>The simplest approach is brute force:</p><ol><li>Identify all boundary pixels (a white pixel with at least one black neighbor).</li><li>For every pixel, compute the nearest distance to the boundary set.</li><li>Assign a positive or negative sign based on whether the pixel itself is inside (white) or outside (black).</li></ol><p>If the total number of pixels is $n$, the complexity is $O(n^2)$.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># generator_sdf.py</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>math</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>PIL</span> <span class=kn>import</span> <span class=n>Image</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>generate_sdf</span><span class=p>(</span><span class=n>input_path</span><span class=p>,</span> <span class=n>output_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># Read grayscale image (0–255)</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>input_path</span><span class=p>)</span><span class=o>.</span><span class=n>convert</span><span class=p>(</span><span class=s2>&#34;L&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>w</span><span class=p>,</span> <span class=n>h</span> <span class=o>=</span> <span class=n>img</span><span class=o>.</span><span class=n>size</span>
</span></span><span class=line><span class=cl>    <span class=n>pixels</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>img</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Step 1: Find boundary pixels</span>
</span></span><span class=line><span class=cl>    <span class=n>boundary_points</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>y</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>h</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>w</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>pixels</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>127</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>neighbors</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=p>(</span><span class=n>nx</span><span class=p>,</span> <span class=n>ny</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>for</span> <span class=n>nx</span> <span class=ow>in</span> <span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>for</span> <span class=n>ny</span> <span class=ow>in</span> <span class=p>(</span><span class=n>y</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=mi>0</span> <span class=o>&lt;=</span> <span class=n>nx</span> <span class=o>&lt;</span> <span class=n>w</span> <span class=ow>and</span> <span class=mi>0</span> <span class=o>&lt;=</span> <span class=n>ny</span> <span class=o>&lt;</span> <span class=n>h</span> <span class=ow>and</span> <span class=ow>not</span> <span class=p>(</span><span class=n>nx</span> <span class=o>==</span> <span class=n>x</span> <span class=ow>and</span> <span class=n>ny</span> <span class=o>==</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>nx</span><span class=p>,</span> <span class=n>ny</span> <span class=ow>in</span> <span class=n>neighbors</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>pixels</span><span class=p>[</span><span class=n>ny</span><span class=p>,</span> <span class=n>nx</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=mi>127</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>boundary_points</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                        <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Step 2 &amp; 3: Compute SDF</span>
</span></span><span class=line><span class=cl>    <span class=n>sdf</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>h</span><span class=p>,</span> <span class=n>w</span><span class=p>),</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>y</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>h</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>w</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>min_dist</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=s2>&#34;inf&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>bx</span><span class=p>,</span> <span class=n>by</span> <span class=ow>in</span> <span class=n>boundary_points</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>dist</span> <span class=o>=</span> <span class=n>math</span><span class=o>.</span><span class=n>sqrt</span><span class=p>((</span><span class=n>x</span> <span class=o>-</span> <span class=n>bx</span><span class=p>)</span> <span class=o>**</span> <span class=mi>2</span> <span class=o>+</span> <span class=p>(</span><span class=n>y</span> <span class=o>-</span> <span class=n>by</span><span class=p>)</span> <span class=o>**</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>dist</span> <span class=o>&lt;</span> <span class=n>min_dist</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>min_dist</span> <span class=o>=</span> <span class=n>dist</span>
</span></span><span class=line><span class=cl>            <span class=c1># Negative for background</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>pixels</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=mi>127</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>min_dist</span> <span class=o>=</span> <span class=o>-</span><span class=n>min_dist</span>
</span></span><span class=line><span class=cl>            <span class=n>sdf</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]</span> <span class=o>=</span> <span class=n>min_dist</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Normalize to 0–255</span>
</span></span><span class=line><span class=cl>    <span class=n>max_dist</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>max</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>sdf</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sdf_normalized</span> <span class=o>=</span> <span class=p>((</span><span class=n>sdf</span> <span class=o>/</span> <span class=n>max_dist</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=mf>127.5</span>
</span></span><span class=line><span class=cl>    <span class=n>sdf_img</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>fromarray</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=n>sdf_normalized</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>255</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>uint8</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sdf_img</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>output_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;SDF saved to </span><span class=si>{</span><span class=n>output_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Example: python generator_sdf.py test.png test_sdf.png&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>generate_sdf</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
</span></span></code></pre></div><p>Generated result:</p><p><img alt="Cicrl SDF" loading=lazy src=/en/posts/signed-distance-field/circle-sdf.png></p><p>By adjusting the display threshold in Photoshop, we can observe the SDF transitions:</p><p><img alt="Circle SDF Threshold" loading=lazy src=/en/posts/signed-distance-field/circle-sdf-threshold.gif></p><p>Similarly, for a square, its SDF exhibits right-angle contours inside and circular contours outside:</p><p><img alt="Square SDF Threshold" loading=lazy src=/en/posts/signed-distance-field/square-sdf-threshold.gif></p><h3 id=8-neighborhood-euclidean-approximation>8-Neighborhood Euclidean Approximation<a hidden class=anchor aria-hidden=true href=#8-neighborhood-euclidean-approximation>#</a></h3><p>A <strong>metric space</strong> <sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup> is an abstract mathematical framework that defines the notion of “distance.” It consists of a set $X$ and a distance function</p><p>$$
d : X \times X \to \mathbb{R}
$$</p><p>which must satisfy the following four conditions:</p><ol><li><strong>Non-negativity</strong>: Distance is always non-negative.</li><li><strong>Identity</strong>: Distance is zero if and only if the two points are identical.</li><li><strong>Symmetry</strong>: The distance from $x$ to $y$ is the same as from $y$ to $x$.</li><li><strong>Triangle inequality</strong>: Taking a detour should never be shorter than going directly.</li></ol><p>$$
d(x, z) \le d(x, y) + d(y, z)
$$</p><p>For example, in the continuous 2D plane, the Euclidean distance</p><p>$$
d(P, Q) = \sqrt{(x_P - x_Q)^2 + (y_P - y_Q)^2}
$$</p><p>is a typical metric.</p><p>In the figure below, the blue, red, and yellow lines all represent the same length, while the green line is the shorter Euclidean distance.</p><p><img alt="Metric Space" loading=lazy src=/en/posts/signed-distance-field/Metric-Space.png></p><p>However, in <strong>digital image processing</strong> or <strong>raster maps</strong>, our points are discrete pixels. While distances can be computed using the Euclidean formula, doing so requires many square root operations, which are computationally expensive.</p><p>To improve efficiency, we often use the <strong>8-neighborhood Euclidean approximation</strong>:</p><ul><li><strong>8-neighborhood</strong>: Each pixel is considered adjacent to the 8 nearest pixels — horizontally, vertically, and diagonally.</li><li>The approximate Euclidean distance is then defined as:</li></ul><p>$$
d_{8}(p, q) \approx \max(\Delta x, \Delta y) + (\sqrt{2} - 1) \cdot \min(\Delta x, \Delta y)
$$</p><p>where $\Delta x = |x_p - x_q|$，$\Delta y = |y_p - y_q|$。</p><p>For example, in the figure below, the red path represents the 8-neighborhood Euclidean approximation, while the blue line is the true Euclidean distance.</p><p><img alt="8-neighborhood Euclidean approximation）：" loading=lazy src=/en/posts/signed-distance-field/8-neighborhood.png></p><p>This method avoids costly square root operations, and within the 8-neighborhood its error compared to the true Euclidean distance is small. Therefore, it is widely used in <strong>pathfinding</strong> (A*, Dijkstra), <strong>distance transforms</strong>, and <strong>morphological image processing</strong>.</p><h3 id=8ssedt>8SSEDT<a hidden class=anchor aria-hidden=true href=#8ssedt>#</a></h3><p>This algorithm is based on Lisapple’s 8SSEDT<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>.</p><p>In the previous section, we introduced the <strong>8-neighborhood Euclidean approximation</strong>. In fact, for each node in the grid, its distance can be expressed recursively as:</p><p>$$
f(x, y) = \min_{\substack{dx, dy \in {-1,0,1} \ (dx, dy) \neq (0,0)}} \Big( f(x+dx, y+dy) + d(dx, dy) \Big)
$$</p><p>where $d(dx, dy)$ is the cost of moving from neighbor $(x+dx, y+dy)$ to $(x, y)$, usually defined as:</p><p>$$
d(dx, dy) =
\begin{cases}
1, & \text{where } |dx| + |dy| = 1 \quad (\text{horizontal or vertical neighbor})\\
\sqrt{2}, & \text{where } |dx| + |dy| = 2 \quad (\text{diagonal neighbor})
\end{cases}
$$</p><p>Here, $dx$ and $dy$ can each be $-1, 0, 1$, but not both zero, since that would not be a neighbor.</p><p>If we label the neighbors:</p><pre tabindex=0><code>[#1][#2][#3]
[#4][ x][#5]
[#6][#7][#8]
</code></pre><p>The path between any two points $x$ and $y$ must be composed of one of the following four combinations:</p><pre tabindex=0><code>1,2,4

2,3,5

4,6,7

5,7,8
</code></pre><p>Thus, propagating from the top-left to the bottom-right covers the $1,2,4$ case, meaning that at most four full passes over the grid are needed to compute all values.</p><p>An optimization, inspired by <strong>Signed Distance Fields</strong><sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup>, chooses the following four traversal paths instead:</p><pre tabindex=0><code>   - - - &gt;
| [?][?][?]
| [?][x][ ]
v [ ][ ][ ]

   &lt; - - -
| [ ][ ][ ]
| [ ][x][?]
v [ ][ ][ ]

   &lt; - - -
^ [ ][ ][ ]
| [ ][x][?]
| [?][?][?]

   - - - &gt;
^ [ ][ ][ ]
| [?][x][ ]
| [ ][ ][ ]
</code></pre><p>Here is the Python implementation:</p><ul><li>Strictly speaking, the following code computes the <strong>true Euclidean distance</strong>, not the 8-neighborhood approximation.</li><li>It only borrows the idea of 8 possible directions of movement.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>PIL</span> <span class=kn>import</span> <span class=n>Image</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>INF</span> <span class=o>=</span> <span class=mi>9999</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>dist_sq</span><span class=p>(</span><span class=n>dx</span><span class=p>,</span> <span class=n>dy</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>dx</span><span class=o>*</span><span class=n>dx</span> <span class=o>+</span> <span class=n>dy</span><span class=o>*</span><span class=n>dy</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>compare</span><span class=p>(</span><span class=n>grid</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>ox</span><span class=p>,</span> <span class=n>oy</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>nx</span> <span class=o>=</span> <span class=n>x</span> <span class=o>+</span> <span class=n>ox</span>
</span></span><span class=line><span class=cl>    <span class=n>ny</span> <span class=o>=</span> <span class=n>y</span> <span class=o>+</span> <span class=n>oy</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=mi>0</span> <span class=o>&lt;=</span> <span class=n>nx</span> <span class=o>&lt;</span> <span class=n>width</span> <span class=ow>and</span> <span class=mi>0</span> <span class=o>&lt;=</span> <span class=n>ny</span> <span class=o>&lt;</span> <span class=n>height</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>other_dx</span><span class=p>,</span> <span class=n>other_dy</span> <span class=o>=</span> <span class=n>grid</span><span class=p>[</span><span class=n>ny</span><span class=p>,</span> <span class=n>nx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>other_dx</span><span class=p>,</span> <span class=n>other_dy</span> <span class=o>=</span> <span class=n>INF</span><span class=p>,</span> <span class=n>INF</span>
</span></span><span class=line><span class=cl>    <span class=n>other_dx</span> <span class=o>+=</span> <span class=n>ox</span>
</span></span><span class=line><span class=cl>    <span class=n>other_dy</span> <span class=o>+=</span> <span class=n>oy</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>dist_sq</span><span class=p>(</span><span class=n>other_dx</span><span class=p>,</span> <span class=n>other_dy</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>dist_sq</span><span class=p>(</span><span class=o>*</span><span class=n>p</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span> <span class=o>=</span> <span class=p>(</span><span class=n>other_dx</span><span class=p>,</span> <span class=n>other_dy</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>generate_sdf</span><span class=p>(</span><span class=n>grid</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>height</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>grid</span><span class=o>.</span><span class=n>shape</span>
</span></span><span class=line><span class=cl>    <span class=c1># Pass 0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>y</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>height</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>width</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>grid</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>compare</span><span class=p>(</span><span class=n>grid</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span>  <span class=mi>0</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>compare</span><span class=p>(</span><span class=n>grid</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span>  <span class=mi>0</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>compare</span><span class=p>(</span><span class=n>grid</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>compare</span><span class=p>(</span><span class=n>grid</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span>  <span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>grid</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]</span> <span class=o>=</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>width</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>grid</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>compare</span><span class=p>(</span><span class=n>grid</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>grid</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]</span> <span class=o>=</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Pass 1</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>y</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>height</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>width</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>grid</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>compare</span><span class=p>(</span><span class=n>grid</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span>  <span class=mi>1</span><span class=p>,</span>  <span class=mi>0</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>compare</span><span class=p>(</span><span class=n>grid</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span>  <span class=mi>0</span><span class=p>,</span>  <span class=mi>1</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>compare</span><span class=p>(</span><span class=n>grid</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span>  <span class=mi>1</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>compare</span><span class=p>(</span><span class=n>grid</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span>  <span class=mi>1</span><span class=p>,</span>  <span class=mi>1</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>grid</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]</span> <span class=o>=</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>width</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>grid</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>compare</span><span class=p>(</span><span class=n>grid</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>grid</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]</span> <span class=o>=</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>load_image_binary</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>threshold</span><span class=o>=</span><span class=mi>128</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>im</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>path</span><span class=p>)</span><span class=o>.</span><span class=n>convert</span><span class=p>(</span><span class=s1>&#39;L&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>arr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>im</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>uint8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>inside</span> <span class=o>=</span> <span class=n>arr</span> <span class=o>&lt;</span> <span class=n>threshold</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>inside</span><span class=p>,</span> <span class=n>im</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>save_signed_sdf_image</span><span class=p>(</span><span class=n>signed</span><span class=p>,</span> <span class=n>out_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>max_dist</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>max</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>signed</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>max_dist</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>sdf_normalized</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full_like</span><span class=p>(</span><span class=n>signed</span><span class=p>,</span> <span class=mf>128.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>sdf_normalized</span> <span class=o>=</span> <span class=p>((</span><span class=n>signed</span> <span class=o>/</span> <span class=n>max_dist</span><span class=p>)</span> <span class=o>+</span> <span class=mf>1.0</span><span class=p>)</span> <span class=o>*</span> <span class=mf>128.0</span>
</span></span><span class=line><span class=cl>    <span class=n>sdf_normalized</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=n>sdf_normalized</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>255</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>uint8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>fromarray</span><span class=p>(</span><span class=n>sdf_normalized</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;L&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>out_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Usage: python 8ssedt.py input.png&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>in_path</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>in_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;File not found:&#34;</span><span class=p>,</span> <span class=n>in_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>inside</span><span class=p>,</span> <span class=n>im</span> <span class=o>=</span> <span class=n>load_image_binary</span><span class=p>(</span><span class=n>in_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span><span class=p>,</span> <span class=n>w</span> <span class=o>=</span> <span class=n>inside</span><span class=o>.</span><span class=n>shape</span>
</span></span><span class=line><span class=cl>    <span class=n>empty</span> <span class=o>=</span> <span class=p>(</span><span class=n>INF</span><span class=p>,</span> <span class=n>INF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>zero</span> <span class=o>=</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># two grids: inside distances and outside distances</span>
</span></span><span class=line><span class=cl>    <span class=n>grid1</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>h</span><span class=p>,</span> <span class=n>w</span><span class=p>,</span> <span class=mi>2</span><span class=p>),</span> <span class=n>dtype</span><span class=o>=</span><span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>grid2</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>h</span><span class=p>,</span> <span class=n>w</span><span class=p>,</span> <span class=mi>2</span><span class=p>),</span> <span class=n>dtype</span><span class=o>=</span><span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>y</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>h</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>w</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>inside</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>grid1</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]</span> <span class=o>=</span> <span class=n>zero</span>
</span></span><span class=line><span class=cl>                <span class=n>grid2</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]</span> <span class=o>=</span> <span class=n>empty</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>grid1</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]</span> <span class=o>=</span> <span class=n>empty</span>
</span></span><span class=line><span class=cl>                <span class=n>grid2</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]</span> <span class=o>=</span> <span class=n>zero</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>generate_sdf</span><span class=p>(</span><span class=n>grid1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>generate_sdf</span><span class=p>(</span><span class=n>grid2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>dist1</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>grid1</span><span class=p>[:,</span> <span class=p>:,</span> <span class=mi>0</span><span class=p>]</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>grid1</span><span class=p>[:,</span> <span class=p>:,</span> <span class=mi>1</span><span class=p>]</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>dist2</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>grid2</span><span class=p>[:,</span> <span class=p>:,</span> <span class=mi>0</span><span class=p>]</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>grid2</span><span class=p>[:,</span> <span class=p>:,</span> <span class=mi>1</span><span class=p>]</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>signed</span> <span class=o>=</span> <span class=n>dist1</span> <span class=o>-</span> <span class=n>dist2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>base</span><span class=p>,</span> <span class=n>ext</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>splitext</span><span class=p>(</span><span class=n>in_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out_path</span> <span class=o>=</span> <span class=n>base</span> <span class=o>+</span> <span class=s2>&#34;_8ssedt.png&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>save_signed_sdf_image</span><span class=p>(</span><span class=n>signed</span><span class=p>,</span> <span class=n>out_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Saved:&#34;</span><span class=p>,</span> <span class=n>out_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div><p>We can test it on this input image:</p><p><img alt="image test" loading=lazy src=/en/posts/signed-distance-field/image_test.png></p><p>After running the script, we get:</p><p><img alt="image test 8ssedt sdf" loading=lazy src=/en/posts/signed-distance-field/image_test_8ssedt.png></p><p>Visualized in Photoshop with different thresholds:</p><p><img alt=image-test-8ssedt-threshold loading=lazy src=/en/posts/signed-distance-field/image-test-8ssedt-threshold.gif></p><h3 id=correct-8ssedt>Correct 8SSEDT<a hidden class=anchor aria-hidden=true href=#correct-8ssedt>#</a></h3><p>As noted in <sup id=fnref:7><a href=#fn:7 class=footnote-ref role=doc-noteref>7</a></sup>, the issue with binary black-and-white images is that for pixels near the boundary, the true distance to the boundary should actually be only half a pixel.</p><p>Ignoring this half-pixel offset leads to small inaccuracies near boundaries. The fix is to add only half the step size when the neighboring pixel is on the boundary.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>math</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>PIL</span> <span class=kn>import</span> <span class=n>Image</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>FIX</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>INF</span> <span class=o>=</span> <span class=mi>9999</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>dist_sq</span><span class=p>(</span><span class=n>dx</span><span class=p>,</span> <span class=n>dy</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>dx</span><span class=o>*</span><span class=n>dx</span> <span class=o>+</span> <span class=n>dy</span><span class=o>*</span><span class=n>dy</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>compare</span><span class=p>(</span><span class=n>grid</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>ox</span><span class=p>,</span> <span class=n>oy</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>nx</span> <span class=o>=</span> <span class=n>x</span> <span class=o>+</span> <span class=n>ox</span>
</span></span><span class=line><span class=cl>    <span class=n>ny</span> <span class=o>=</span> <span class=n>y</span> <span class=o>+</span> <span class=n>oy</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=mi>0</span> <span class=o>&lt;=</span> <span class=n>nx</span> <span class=o>&lt;</span> <span class=n>width</span> <span class=ow>and</span> <span class=mi>0</span> <span class=o>&lt;=</span> <span class=n>ny</span> <span class=o>&lt;</span> <span class=n>height</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>other_dx</span><span class=p>,</span> <span class=n>other_dy</span> <span class=o>=</span> <span class=n>grid</span><span class=p>[</span><span class=n>ny</span><span class=p>,</span> <span class=n>nx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>other_dx</span><span class=p>,</span> <span class=n>other_dy</span> <span class=o>=</span> <span class=n>INF</span><span class=p>,</span> <span class=n>INF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>FIX</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>other_dx</span> <span class=o>!=</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>other_dy</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>ox</span> <span class=o>*=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>            <span class=n>oy</span> <span class=o>*=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>other_dx</span> <span class=o>+=</span> <span class=n>ox</span>
</span></span><span class=line><span class=cl>    <span class=n>other_dy</span> <span class=o>+=</span> <span class=n>oy</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>dist_sq</span><span class=p>(</span><span class=n>other_dx</span><span class=p>,</span> <span class=n>other_dy</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>dist_sq</span><span class=p>(</span><span class=o>*</span><span class=n>p</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span> <span class=o>=</span> <span class=p>(</span><span class=n>other_dx</span><span class=p>,</span> <span class=n>other_dy</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>generate_sdf</span><span class=p>(</span><span class=n>grid</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>height</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>grid</span><span class=o>.</span><span class=n>shape</span>
</span></span><span class=line><span class=cl>    <span class=c1># Pass 0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>y</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>height</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>width</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>grid</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>compare</span><span class=p>(</span><span class=n>grid</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span>  <span class=mi>0</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>compare</span><span class=p>(</span><span class=n>grid</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span>  <span class=mi>0</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>compare</span><span class=p>(</span><span class=n>grid</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>compare</span><span class=p>(</span><span class=n>grid</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span>  <span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>grid</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]</span> <span class=o>=</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>width</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>grid</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>compare</span><span class=p>(</span><span class=n>grid</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>grid</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]</span> <span class=o>=</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Pass 1</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>y</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>height</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>width</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>grid</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>compare</span><span class=p>(</span><span class=n>grid</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span>  <span class=mi>1</span><span class=p>,</span>  <span class=mi>0</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>compare</span><span class=p>(</span><span class=n>grid</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span>  <span class=mi>0</span><span class=p>,</span>  <span class=mi>1</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>compare</span><span class=p>(</span><span class=n>grid</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span>  <span class=mi>1</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>compare</span><span class=p>(</span><span class=n>grid</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span>  <span class=mi>1</span><span class=p>,</span>  <span class=mi>1</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>grid</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]</span> <span class=o>=</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>width</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>grid</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>compare</span><span class=p>(</span><span class=n>grid</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>grid</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]</span> <span class=o>=</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>load_image_binary</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>threshold</span><span class=o>=</span><span class=mi>128</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>im</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>path</span><span class=p>)</span><span class=o>.</span><span class=n>convert</span><span class=p>(</span><span class=s1>&#39;L&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>arr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>im</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>uint8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>inside</span> <span class=o>=</span> <span class=n>arr</span> <span class=o>&lt;</span> <span class=n>threshold</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>inside</span><span class=p>,</span> <span class=n>im</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>save_signed_sdf_image</span><span class=p>(</span><span class=n>signed</span><span class=p>,</span> <span class=n>out_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>max_dist</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>max</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>signed</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>max_dist</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>sdf_normalized</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full_like</span><span class=p>(</span><span class=n>signed</span><span class=p>,</span> <span class=mf>128.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>sdf_normalized</span> <span class=o>=</span> <span class=p>((</span><span class=n>signed</span> <span class=o>/</span> <span class=n>max_dist</span><span class=p>)</span> <span class=o>+</span> <span class=mf>1.0</span><span class=p>)</span> <span class=o>*</span> <span class=mf>128.0</span>
</span></span><span class=line><span class=cl>    <span class=n>sdf_normalized</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=n>sdf_normalized</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>255</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>uint8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>fromarray</span><span class=p>(</span><span class=n>sdf_normalized</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;L&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>out_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Usage: python 8ssedt.py input.png&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>in_path</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>in_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;File not found:&#34;</span><span class=p>,</span> <span class=n>in_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>inside</span><span class=p>,</span> <span class=n>im</span> <span class=o>=</span> <span class=n>load_image_binary</span><span class=p>(</span><span class=n>in_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span><span class=p>,</span> <span class=n>w</span> <span class=o>=</span> <span class=n>inside</span><span class=o>.</span><span class=n>shape</span>
</span></span><span class=line><span class=cl>    <span class=n>empty</span> <span class=o>=</span> <span class=p>(</span><span class=n>INF</span><span class=p>,</span> <span class=n>INF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>zero</span> <span class=o>=</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># two grids: inside distances and outside distances</span>
</span></span><span class=line><span class=cl>    <span class=n>grid1</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>h</span><span class=p>,</span> <span class=n>w</span><span class=p>,</span> <span class=mi>2</span><span class=p>),</span> <span class=n>dtype</span><span class=o>=</span><span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>grid2</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>h</span><span class=p>,</span> <span class=n>w</span><span class=p>,</span> <span class=mi>2</span><span class=p>),</span> <span class=n>dtype</span><span class=o>=</span><span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>y</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>h</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>w</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>inside</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>grid1</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]</span> <span class=o>=</span> <span class=n>zero</span>
</span></span><span class=line><span class=cl>                <span class=n>grid2</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]</span> <span class=o>=</span> <span class=n>empty</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>grid1</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]</span> <span class=o>=</span> <span class=n>empty</span>
</span></span><span class=line><span class=cl>                <span class=n>grid2</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]</span> <span class=o>=</span> <span class=n>zero</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>generate_sdf</span><span class=p>(</span><span class=n>grid1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>generate_sdf</span><span class=p>(</span><span class=n>grid2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>dist1</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>grid1</span><span class=p>[:,</span> <span class=p>:,</span> <span class=mi>0</span><span class=p>]</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>grid1</span><span class=p>[:,</span> <span class=p>:,</span> <span class=mi>1</span><span class=p>]</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>dist2</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>grid2</span><span class=p>[:,</span> <span class=p>:,</span> <span class=mi>0</span><span class=p>]</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>grid2</span><span class=p>[:,</span> <span class=p>:,</span> <span class=mi>1</span><span class=p>]</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>FIX</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>signed</span> <span class=o>=</span> <span class=mf>0.5</span> <span class=o>*</span> <span class=p>(</span><span class=n>dist1</span> <span class=o>-</span> <span class=n>dist2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>signed</span> <span class=o>=</span> <span class=n>dist1</span> <span class=o>-</span> <span class=n>dist2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>base</span><span class=p>,</span> <span class=n>ext</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>splitext</span><span class=p>(</span><span class=n>in_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out_path</span> <span class=o>=</span> <span class=n>base</span> <span class=o>+</span> <span class=s2>&#34;_8ssedt_correct.png&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>save_signed_sdf_image</span><span class=p>(</span><span class=n>signed</span><span class=p>,</span> <span class=n>out_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Saved:&#34;</span><span class=p>,</span> <span class=n>out_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div><p>The results look nearly identical to the original:</p><p><img alt=image_test_8ssedt_correct loading=lazy src=/en/posts/signed-distance-field/image_test_8ssedt_correct.png></p><p>But when visualized at different thresholds, the corrected version is slightly smoother near boundaries:</p><p>Corrected:</p><p><img alt=image_test_8ssedt_correct_threshold loading=lazy src=/en/posts/signed-distance-field/image_test_8ssedt_correct_threshold.png></p><p>Original:</p><p><img alt=image_test_8ssedt_threshold loading=lazy src=/en/posts/signed-distance-field/image_test_8ssedt_threshold.png></p><h3 id=why-still-use-euclidean-distance>Why Still Use Euclidean Distance?<a hidden class=anchor aria-hidden=true href=#why-still-use-euclidean-distance>#</a></h3><p>Consider the approximation formula:</p><p>$$
d_8(p,q) = \max(\Delta x,\Delta y) + (\sqrt{2} - 1) \cdot \min(\Delta x,\Delta y)
$$</p><p>Take two points: $(1,4)$ and $(3,3)$.</p><ul><li><p><strong>计算 $d_8$</strong></p><ul><li><p>$d_8(1,4) = 4 + (\sqrt{2} - 1) \cdot 1 \approx 4 + 0.4142 = 4.4142$</p></li><li><p>$d_8(3,3) = 3 + (\sqrt{2} - 1) \cdot 3 \approx 3 + 1.2426 = 4.2426$</p><p>⇒ $d_8(1,4) > d_8(3,3)$</p></li></ul></li><li><p><strong>计算欧几里得距离</strong></p><ul><li><p>$d_E(1,4) = \sqrt{1^2 + 4^2} = \sqrt{17} \approx 4.1231$</p></li><li><p>$d_E(3,3) = \sqrt{3^2 + 3^2} = \sqrt{18} \approx 4.2426$</p><p>⇒ $d_E(1,4) &lt; d_E(3,3)$</p></li></ul></li></ul><p>This counterexample shows that $d_8$ does not always preserve the same ordering as Euclidean distance. Therefore, we only borrow the 8-neighborhood displacements, but still compute distances using the Euclidean metric.</p><h3 id=the-scipyndimage-library>The scipy.ndimage Library<a hidden class=anchor aria-hidden=true href=#the-scipyndimage-library>#</a></h3><p>The previous Python implementation is slow due to nested loops, especially at resolutions like 2048×2048.</p><p>scipy.ndimage provides a much faster alternative, as its image processing functions are implemented in C++.</p><p>In the following code, we use a fixed scale of 8 (explained later), and output 16-bit grayscale images instead of 8-bit.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>PIL</span> <span class=kn>import</span> <span class=n>Image</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>scipy</span> <span class=kn>import</span> <span class=n>ndimage</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>scale</span> <span class=o>=</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>load_image_binary</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>threshold</span><span class=o>=</span><span class=mi>128</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>im</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>path</span><span class=p>)</span><span class=o>.</span><span class=n>convert</span><span class=p>(</span><span class=s1>&#39;L&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>arr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>im</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>uint8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>inside</span> <span class=o>=</span> <span class=n>arr</span> <span class=o>&lt;</span> <span class=n>threshold</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>inside</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>save_sdf_16bit</span><span class=p>(</span><span class=n>signed</span><span class=p>,</span> <span class=n>out_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>signed</span> <span class=o>=</span> <span class=n>signed</span> <span class=o>*</span> <span class=n>scale</span> <span class=o>+</span> <span class=mf>32767.5</span>
</span></span><span class=line><span class=cl>    <span class=n>signed_uint16</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=n>signed</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>65535</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>uint16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>fromarray</span><span class=p>(</span><span class=n>signed_uint16</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;I;16&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>out_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>fast_signed_sdf</span><span class=p>(</span><span class=n>mask</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>dist_inside</span> <span class=o>=</span> <span class=n>ndimage</span><span class=o>.</span><span class=n>distance_transform_edt</span><span class=p>(</span><span class=n>mask</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>dist_outside</span> <span class=o>=</span> <span class=n>ndimage</span><span class=o>.</span><span class=n>distance_transform_edt</span><span class=p>(</span><span class=o>~</span><span class=n>mask</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>dist_outside</span> <span class=o>-</span> <span class=n>dist_inside</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Usage: python fast_sdf.py input1.png [input2.png ...]&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>in_path</span> <span class=ow>in</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>:]:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>in_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;File not found:&#34;</span><span class=p>,</span> <span class=n>in_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>inside</span> <span class=o>=</span> <span class=n>load_image_binary</span><span class=p>(</span><span class=n>in_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>signed</span> <span class=o>=</span> <span class=n>fast_signed_sdf</span><span class=p>(</span><span class=n>inside</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>base</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>splitext</span><span class=p>(</span><span class=n>in_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>out_path</span> <span class=o>=</span> <span class=n>base</span> <span class=o>+</span> <span class=s2>&#34;_sdf16.png&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>save_sdf_16bit</span><span class=p>(</span><span class=n>signed</span><span class=p>,</span> <span class=n>out_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Saved SDF to </span><span class=si>{</span><span class=n>out_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div><h3 id=16bit-和-scale>16bit 和 scale<a hidden class=anchor aria-hidden=true href=#16bit-和-scale>#</a></h3><p>Earlier, we normalized distances, but if we want to combine multiple images, the distance units must be consistent (since interpolation between SDFs depends on this).</p><p>Furthermore, with large images (e.g., 2048×2048), 8-bit depth (0–255) is insufficient to represent the full range of distances. To avoid truncation artifacts, we use 16-bit PNGs.</p><p>For a 2048×2048 image, the maximum possible distance is about $2048 \cdot 1.414 \approx 2896$. Since 16-bit integers can represent up to $\pm32767$, we can safely choose a scale factor of 8 or 10.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=n>scale</span> <span class=o>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=c1># Map to 0–65535, 32767.5 as the boundary</span>
</span></span><span class=line><span class=cl><span class=n>unsigned</span> <span class=o>=</span> <span class=n>signed</span> <span class=o>*</span> <span class=n>scale</span> <span class=o>+</span> <span class=mf>32767.5</span>
</span></span><span class=line><span class=cl><span class=n>unsigned</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=n>unsigned</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>65535</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>uint16</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=composition-algorithms>Composition Algorithms<a hidden class=anchor aria-hidden=true href=#composition-algorithms>#</a></h2><p>How to combine SDFs depends on the desired effect.</p><p>For example, if we want a subtraction, can we simply subtract the distance fields?</p><p>This works at the midpoint, but at the edges the meaning becomes unclear:</p><p><img alt=subtraction loading=lazy src=/en/posts/signed-distance-field/subtraction.gif></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Boolean operations</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sdf_union</span><span class=p>(</span><span class=n>d1</span><span class=p>,</span> <span class=n>d2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>minimum</span><span class=p>(</span><span class=n>d1</span><span class=p>,</span> <span class=n>d2</span><span class=p>)</span>  <span class=c1># Union</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sdf_intersection</span><span class=p>(</span><span class=n>d1</span><span class=p>,</span> <span class=n>d2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>maximum</span><span class=p>(</span><span class=n>d1</span><span class=p>,</span> <span class=n>d2</span><span class=p>)</span>  <span class=c1># Intersection</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sdf_subtraction</span><span class=p>(</span><span class=n>d1</span><span class=p>,</span> <span class=n>d2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>maximum</span><span class=p>(</span><span class=n>d1</span><span class=p>,</span> <span class=o>-</span><span class=n>d2</span><span class=p>)</span> <span class=c1># A subtract B</span>
</span></span></code></pre></div><p>These operations essentially define the effect when crossing the threshold boundary.</p><h3 id=interpolation-approach>Interpolation Approach<a hidden class=anchor aria-hidden=true href=#interpolation-approach>#</a></h3><p><img alt="compose demo" loading=lazy src=/en/posts/signed-distance-field/compose_demo.gif></p><p>In games, what we often want is this: given two images a and b, at maximum threshold we see a, at minimum threshold we see b.</p><p>For three images, the highest threshold shows a, the middle threshold shows b, and the lowest threshold shows c, and so on.</p><p>A key requirement is that they must have a containment relationship: $c \supset b \supset a$. Otherwise, the transition cannot be well-defined.</p><p>For an arbitrary pixel in a, its distance values in both a and b should be positive (inside).</p><p>For a pixel in $b - a$, its distance in a will be negative ($x_a$), and in b positive ($x_b$). Thus, the final SDF value $x_{final}$ is determined by finding the threshold where interpolation between $x_a$ and $x_b$ crosses zero.</p><p>For example, if ${sdf}_a = -3$ and ${sdf}b = 3$, then at 8-bit gray, ${x}{final}$ should be 128 — meaning the pixel is lit at thresholds below 128.</p><p>So the core idea is: find the zero-crossing point.</p><h3 id=monte-carlo-interpolation>Monte Carlo Interpolation<a hidden class=anchor aria-hidden=true href=#monte-carlo-interpolation>#</a></h3><p>We can approximate the zero point via sampling, as in <sup id=fnref:8><a href=#fn:8 class=footnote-ref role=doc-noteref>8</a></sup>.</p><p>Note that pure Python with nested loops is too slow for large images (>2048).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>PIL</span> <span class=kn>import</span> <span class=n>Image</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Usage: python compose2.py a.png b.png&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Load a 16-bit grayscale image</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>load_16bit_gray</span><span class=p>(</span><span class=n>path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>arr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>uint16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>arr</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sdf1</span> <span class=o>=</span> <span class=n>load_16bit_gray</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>sdf2</span> <span class=o>=</span> <span class=n>load_16bit_gray</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Ensure dimensions match</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>sdf1</span><span class=o>.</span><span class=n>shape</span> <span class=o>!=</span> <span class=n>sdf2</span><span class=o>.</span><span class=n>shape</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;The two input images must have the same dimensions&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>height</span><span class=p>,</span> <span class=n>width</span> <span class=o>=</span> <span class=n>sdf1</span><span class=o>.</span><span class=n>shape</span>
</span></span><span class=line><span class=cl><span class=n>output</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>height</span><span class=p>,</span> <span class=n>width</span><span class=p>),</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>uint16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>THRESHOLD</span> <span class=o>=</span> <span class=mi>32768</span>   <span class=c1># 16-bit midpoint (0.5 grayscale)</span>
</span></span><span class=line><span class=cl><span class=n>MAX_VAL</span> <span class=o>=</span> <span class=mi>65535</span>
</span></span><span class=line><span class=cl><span class=n>STEPS</span> <span class=o>=</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>y</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>height</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>width</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>t1</span> <span class=o>=</span> <span class=n>sdf1</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>t2</span> <span class=o>=</span> <span class=n>sdf2</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>t1</span> <span class=o>&lt;</span> <span class=n>THRESHOLD</span> <span class=ow>and</span> <span class=n>t2</span> <span class=o>&lt;</span> <span class=n>THRESHOLD</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>t1</span> <span class=o>&gt;</span> <span class=n>THRESHOLD</span> <span class=ow>and</span> <span class=n>t2</span> <span class=o>&gt;</span> <span class=n>THRESHOLD</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>MAX_VAL</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Interpolate between the two images</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>STEPS</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>weight</span> <span class=o>=</span> <span class=n>i</span> <span class=o>/</span> <span class=n>STEPS</span>
</span></span><span class=line><span class=cl>                <span class=n>interp</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>weight</span><span class=p>)</span> <span class=o>*</span> <span class=n>t1</span> <span class=o>+</span> <span class=n>weight</span> <span class=o>*</span> <span class=n>t2</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span> <span class=o>+=</span> <span class=mi>0</span> <span class=k>if</span> <span class=n>interp</span> <span class=o>&lt;</span> <span class=n>THRESHOLD</span> <span class=k>else</span> <span class=n>MAX_VAL</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>//=</span> <span class=n>STEPS</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>output</span><span class=p>[</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>MAX_VAL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Save as 16-bit PNG</span>
</span></span><span class=line><span class=cl><span class=n>out_img</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>fromarray</span><span class=p>(</span><span class=n>output</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;I;16&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>out_img</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=s2>&#34;output.png&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Composition complete: output.png&#34;</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=final-algorithm>Final Algorithm<a hidden class=anchor aria-hidden=true href=#final-algorithm>#</a></h3><p>This interpolation is highly parallel: each pixel is independent, and interpolating across images is also independent.</p><p>Using NumPy for vectorized operations achieves high performance (NumPy is backed by optimized C++).</p><p>Here we sample 256 points across the grayscale range, and output an 8-bit grayscale image (16-bit is unnecessary for the final composite).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>PIL</span> <span class=kn>import</span> <span class=n>Image</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>U8</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Example: python compose.py img1.png img2.png [img3.png ...]&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>load_16bit_gray</span><span class=p>(</span><span class=n>path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>arr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>uint16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>arr</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>images</span> <span class=o>=</span> <span class=p>[</span><span class=n>load_16bit_gray</span><span class=p>(</span><span class=n>path</span><span class=p>)</span> <span class=k>for</span> <span class=n>path</span> <span class=ow>in</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>:]]</span>
</span></span><span class=line><span class=cl><span class=n>arr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>stack</span><span class=p>(</span><span class=n>images</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>  <span class=c1># shape: (N, H, W)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=ow>not</span> <span class=n>np</span><span class=o>.</span><span class=n>all</span><span class=p>([</span><span class=n>img</span><span class=o>.</span><span class=n>shape</span> <span class=o>==</span> <span class=n>arr</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>shape</span> <span class=k>for</span> <span class=n>img</span> <span class=ow>in</span> <span class=n>images</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>    <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;All input images must have the same dimensions&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>THRESHOLD</span> <span class=o>=</span> <span class=mi>32768</span>
</span></span><span class=line><span class=cl><span class=n>MAX_VAL</span> <span class=o>=</span> <span class=mi>65535</span>
</span></span><span class=line><span class=cl><span class=n>N</span><span class=p>,</span> <span class=n>H</span><span class=p>,</span> <span class=n>W</span> <span class=o>=</span> <span class=n>arr</span><span class=o>.</span><span class=n>shape</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Global masks</span>
</span></span><span class=line><span class=cl><span class=n>all_below</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>all</span><span class=p>(</span><span class=n>arr</span> <span class=o>&lt;</span> <span class=n>THRESHOLD</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>all_above</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>all</span><span class=p>(</span><span class=n>arr</span> <span class=o>&gt;</span> <span class=n>THRESHOLD</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>output</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>H</span><span class=p>,</span> <span class=n>W</span><span class=p>),</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float64</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>output</span><span class=p>[</span><span class=n>all_below</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>output</span><span class=p>[</span><span class=n>all_above</span><span class=p>]</span> <span class=o>=</span> <span class=n>MAX_VAL</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Mixed region mask</span>
</span></span><span class=line><span class=cl><span class=n>mix_mask</span> <span class=o>=</span> <span class=o>~</span><span class=p>(</span><span class=n>all_below</span> <span class=o>|</span> <span class=n>all_above</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Extract pixels in the mixed region</span>
</span></span><span class=line><span class=cl><span class=n>mix_pixels</span> <span class=o>=</span> <span class=n>arr</span><span class=p>[:,</span> <span class=n>mix_mask</span><span class=p>]</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>float64</span><span class=p>)</span>  <span class=c1># shape: (N, M)  M = number of mixed pixels</span>
</span></span><span class=line><span class=cl><span class=n>M</span> <span class=o>=</span> <span class=n>mix_pixels</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 256 sampling weights</span>
</span></span><span class=line><span class=cl><span class=n>samples</span> <span class=o>=</span> <span class=mi>256</span>
</span></span><span class=line><span class=cl><span class=n>weights</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>linspace</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>samples</span><span class=p>,</span> <span class=n>endpoint</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Which two images each sample point belongs to</span>
</span></span><span class=line><span class=cl><span class=n>intervals</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>floor</span><span class=p>(</span><span class=n>weights</span> <span class=o>*</span> <span class=p>(</span><span class=n>N</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>  <span class=c1># shape: (samples,)</span>
</span></span><span class=line><span class=cl><span class=n>local_w</span> <span class=o>=</span> <span class=p>(</span><span class=n>weights</span> <span class=o>*</span> <span class=p>(</span><span class=n>N</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span> <span class=o>-</span> <span class=n>intervals</span>           <span class=c1># shape: (samples,)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Batch interpolation</span>
</span></span><span class=line><span class=cl><span class=n>interp_results</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>samples</span><span class=p>,</span> <span class=n>M</span><span class=p>),</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>samples</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>i1</span> <span class=o>=</span> <span class=n>intervals</span><span class=p>[</span><span class=n>k</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>i2</span> <span class=o>=</span> <span class=n>i1</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>val</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>local_w</span><span class=p>[</span><span class=n>k</span><span class=p>])</span> <span class=o>*</span> <span class=n>mix_pixels</span><span class=p>[</span><span class=n>i1</span><span class=p>]</span> <span class=o>+</span> <span class=n>local_w</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>*</span> <span class=n>mix_pixels</span><span class=p>[</span><span class=n>i2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>interp_results</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>val</span> <span class=o>&gt;=</span> <span class=n>THRESHOLD</span><span class=p>)</span> <span class=o>*</span> <span class=n>MAX_VAL</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Average results</span>
</span></span><span class=line><span class=cl><span class=n>res</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>interp_results</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Write results back</span>
</span></span><span class=line><span class=cl><span class=n>output</span><span class=p>[</span><span class=n>mix_mask</span><span class=p>]</span> <span class=o>=</span> <span class=n>res</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>U8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># Convert to float, map to 0–255</span>
</span></span><span class=line><span class=cl>    <span class=n>output_float</span> <span class=o>=</span> <span class=n>output</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>output_scaled</span> <span class=o>=</span> <span class=n>output_float</span> <span class=o>/</span> <span class=mf>65535.0</span> <span class=o>*</span> <span class=mf>255.0</span>
</span></span><span class=line><span class=cl>    <span class=n>output_uint8</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>floor</span><span class=p>(</span><span class=n>output_scaled</span> <span class=o>+</span> <span class=mf>0.5</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>255</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>uint8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># Save 8-bit grayscale</span>
</span></span><span class=line><span class=cl>    <span class=n>out_img</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>fromarray</span><span class=p>(</span><span class=n>output_uint8</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;L&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out_img</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=s2>&#34;output8.png&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Composition complete: output8.png, merged </span><span class=si>{</span><span class=n>N</span><span class=si>}</span><span class=s2> images&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span><span class=n>output</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>MAX_VAL</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>uint16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out_img</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>fromarray</span><span class=p>(</span><span class=n>output</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;I;16&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out_img</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=s2>&#34;output16.png&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Composition complete: output16.png, merged </span><span class=si>{</span><span class=n>N</span><span class=si>}</span><span class=s2> images&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>Result:</p><p>Original images:</p><p><img alt="compose origin image" loading=lazy src=/en/posts/signed-distance-field/compose_origin.png></p><p>Generated SDFs (scaled, so they appear grayish):</p><p><img alt="compose sdf image" loading=lazy src=/en/posts/signed-distance-field/compose_origin_sdf.png></p><p>Composited SDF:</p><p><img alt="compose origin sdf demo" loading=lazy src=/en/posts/signed-distance-field/compose_origin_sdf_demo.gif></p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>wikipedia, Signed distance function, <a href=https://en.wikipedia.org/wiki/Signed_distance_function>https://en.wikipedia.org/wiki/Signed_distance_function</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>cronrpc, (2025), Signed Distance Field 2D Generator, <a href=https://github.com/cronrpc/Signed-Distance-Field-2D-Generator>https://github.com/cronrpc/Signed-Distance-Field-2D-Generator</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>Chris Green. Valve. (2007). Improved Alpha-Tested Magnification for Vector Textures and Special Effects, <a href=https://steamcdn-a.akamaihd.net/apps/valve/2007/SIGGRAPH2007_AlphaTestedMagnification.pdf>https://steamcdn-a.akamaihd.net/apps/valve/2007/SIGGRAPH2007_AlphaTestedMagnification.pdf</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>Metric Space, <a href=https://en.wikipedia.org/wiki/Metric_space>https://en.wikipedia.org/wiki/Metric_space</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p>Lisapple, (2017), 8SSEDT , GitHub, <a href=https://github.com/Lisapple/8SSEDT>https://github.com/Lisapple/8SSEDT</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p>Richard Mitton, (2009), Signed Distance Fields, <a href=http://www.codersnotes.com/notes/signed-distance-fields/>http://www.codersnotes.com/notes/signed-distance-fields/</a>&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:7><p>farteryhr, Correct 8SSEDT, <a href=https://replit.com/@farteryhr/Correct8SSEDT#main.cpp>https://replit.com/@farteryhr/Correct8SSEDT#main.cpp</a>&#160;<a href=#fnref:7 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:8><p>蛋白胨, Unity 卡通渲染 程序化天空盒, <a href=https://zhuanlan.zhihu.com/p/540692272>https://zhuanlan.zhihu.com/p/540692272</a>&#160;<a href=#fnref:8 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://cronrpc.github.io/en/tags/image-processing/>Image Processing</a></li><li><a href=https://cronrpc.github.io/en/tags/sdf/>Sdf</a></li></ul><nav class=paginav><a class=prev href=https://cronrpc.github.io/en/posts/worley-noise-generator/><span class=title>« Prev</span><br><span>Worley Noise / Voronoi Noise Generator</span>
</a><a class=next href=https://cronrpc.github.io/en/posts/perlin-noise-generator/><span class=title>Next »</span><br><span>Perlin Noise Generator</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Signed Distance Field on x" href="https://x.com/intent/tweet/?text=Signed%20Distance%20Field&amp;url=https%3a%2f%2fcronrpc.github.io%2fen%2fposts%2fsigned-distance-field%2f&amp;hashtags=ImageProcessing%2csdf"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Signed Distance Field on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fcronrpc.github.io%2fen%2fposts%2fsigned-distance-field%2f&amp;title=Signed%20Distance%20Field&amp;summary=Signed%20Distance%20Field&amp;source=https%3a%2f%2fcronrpc.github.io%2fen%2fposts%2fsigned-distance-field%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Signed Distance Field on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fcronrpc.github.io%2fen%2fposts%2fsigned-distance-field%2f&title=Signed%20Distance%20Field"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Signed Distance Field on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fcronrpc.github.io%2fen%2fposts%2fsigned-distance-field%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Signed Distance Field on whatsapp" href="https://api.whatsapp.com/send?text=Signed%20Distance%20Field%20-%20https%3a%2f%2fcronrpc.github.io%2fen%2fposts%2fsigned-distance-field%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Signed Distance Field on telegram" href="https://telegram.me/share/url?text=Signed%20Distance%20Field&amp;url=https%3a%2f%2fcronrpc.github.io%2fen%2fposts%2fsigned-distance-field%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Signed Distance Field on ycombinator" href="https://news.ycombinator.com/submitlink?t=Signed%20Distance%20Field&u=https%3a%2f%2fcronrpc.github.io%2fen%2fposts%2fsigned-distance-field%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://cronrpc.github.io/en/>cronrpc</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>